name: Release

on:
    workflow_run:
        workflows: ['Package']
        types: [completed]
    workflow_dispatch: {}

permissions:
    contents: write

jobs:
    release:
        name: Create Release (tag short hash)
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get short commit hash
              id: vars
              run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

            - name: Get package version
              id: version
              run: |
                  version=$(node -p "require('./package.json').version") || echo "version="
                  # Remove leading v if present
                  version_no_v=${version#v}
                  echo "version=${version_no_v}" >> $GITHUB_OUTPUT

            - name: Set tag name
              id: set_tag
              run: |
                  version="${{ steps.version.outputs.version }}"
                  short_sha="${{ steps.vars.outputs.short_sha }}"
                  version_no_v="${version#v}"
                  if [ -n "$version_no_v" ]; then
                    echo "tag_name=${version_no_v}" >> $GITHUB_OUTPUT
                  else
                    echo "tag_name=${short_sha}" >> $GITHUB_OUTPUT
                  fi

            - name: Check for code changes
              id: changes
              uses: dorny/paths-filter@v2
              with:
                  filters: |
                      code:
                        - 'injector/**'
                        - 'package.json'
                        - '*.hbs'
                        - 'assets/**'
                        - '*.js'

            - name: Check for prior tags
              id: has_tags
              run: |
                git fetch --tags || true
                tag_count=$(git tag | wc -l)
                if [ "$tag_count" -eq 0 ]; then
                  echo "no_tag=true" >> $GITHUB_OUTPUT
                else
                  echo "no_tag=false" >> $GITHUB_OUTPUT
                fi

            - name: Create tag and push
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              env:
                  TAG_NAME: "${{ steps.set_tag.outputs.tag_name }}"
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  # Ensure tag does not have leading v; strip if needed
                  local_tag=${TAG_NAME#v}
                  git tag -a ${local_tag} -m "Release ${local_tag}" || echo "tag exists"
                  # set or update latest tag to point to this commit
                  git tag -f latest ${local_tag} || true
                  git push origin --tags || echo "tags push failed"
                  git push --force origin latest || true

            - name: Download coverage artifact
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              uses: actions/download-artifact@v4
              with:
                  name: coverage-report
                  path: coverage

            - name: Generate coverage badge
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install dependencies (for badge)
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              run: npm ci

            - name: Create badge file
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              run: npm run coverage:badge

            - name: Commit coverage badge
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              run: |
                  if [ -f badges/coverage.svg ]; then
                    git add badges/coverage.svg || true
                    if git diff --staged --quiet; then
                      echo "No badge changes to commit"
                    else
                      git config user.name "github-actions[bot]"
                      git config user.email "github-actions[bot]@users.noreply.github.com"
                      git commit -m "chore(ci): update coverage badge [skip ci]" || echo "no commit"
                      git push origin main || echo "push failed"
                    fi
                  fi

            - name: Download package artifact
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              uses: actions/download-artifact@v4
              with:
                  name: npm-package

            - name: Prepare package artifact for publish
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              run: |
                  mkdir -p pkg
                  mv *.tgz pkg/ 2>/dev/null || true

            - name: Use Node.js for npm publish
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  registry-url: 'https://registry.npmjs.org'

            - name: Install dependencies for npm publish
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              run: npm ci

            - name: Publish package to npm (conditional)
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              env:
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                  if [ -z "${NPM_TOKEN}" ]; then
                    echo "NPM_TOKEN not set; skipping npm publish"
                    exit 0
                  fi
                  PRIVATE=$(node -e "console.log(require('./package.json').private)")
                    if [ "$PRIVATE" = "true" ]; then
                      echo "package.json is private; skipping npm publish"
                      exit 0
                    fi
                    echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
                    npm publish --access public || npm publish

            - name: Create GitHub release
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              uses: actions/create-release@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                tag_name: "${{ steps.set_tag.outputs.tag_name }}"
                release_name: "Release ${{ steps.set_tag.outputs.tag_name }}"
                body: |-
                  Auto-generated release from workflow. Tag ${{ steps.set_tag.outputs.tag_name }}.
                draft: false
                prerelease: false

            - name: Upload package to release
              if: ${{ steps.changes.outputs.code == 'true' || steps.has_tags.outputs.no_tag == 'true' }}
              uses: softprops/action-gh-release@v1
              with:
                  files: 'pkg/*.tgz'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
