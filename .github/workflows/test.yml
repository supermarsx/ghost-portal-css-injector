name: Test

on:
    push:
        branches: [main]
        paths-ignore: ['badges/**']
    pull_request:
        branches: [main]
    workflow_dispatch: {}

permissions:
  contents: write

jobs:
    test:
        name: Test (Jest)
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
            - name: Install dependencies
              run: npm install
            - name: Run tests
              run: npm test
            - name: Upload coverage artifact
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage
            - name: Generate coverage badge (artifact and file)
              run: |
                  npm run coverage:badge
                  mkdir -p badges
                  ls -la badges || true

            - name: Commit coverage badge
              if: github.ref == 'refs/heads/main'
              run: |
                  if [ -f badges/coverage.svg ]; then
                      git config user.name "github-actions[bot]"
                      git config user.email "github-actions[bot]@users.noreply.github.com"
                      git add badges/coverage.svg || true
                      if git diff --staged --quiet; then
                        echo "No coverage badge changes to commit"
                      else
                        git commit -m "chore(ci): update coverage badge [skip ci]" || echo "no commit"
                        git push origin main || echo "push failed"
                      fi
                  else
                      echo "No coverage badge file to commit"
                  fi
